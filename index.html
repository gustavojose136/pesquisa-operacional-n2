<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>PL Logística – Q1, Q2 & Q3</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">PL Logística</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-endpoint="http://127.0.0.1:8000/api/questao1">Questão 1</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-endpoint="http://127.0.0.1:8000/api/questao2">Questão 2</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-endpoint="http://127.0.0.1:8000/api/questao3">Questão 3</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container">

    <div class="row mb-3">
      <div class="col">
        <h1 id="titulo" class="h3 text-secondary"></h1>
        <p id="descricao"></p>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col">
        <div class="card shadow-sm">
          <div class="card-header bg-white"><strong>História</strong></div>
          <div class="card-body">
            <p id="historia-text" class="mb-0"></p>
          </div>
        </div>
      </div>
    </div>

    <div class="row gy-4 mb-4">
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header bg-white"><strong>Variáveis</strong></div>
          <ul class="list-group list-group-flush" id="lista-vars"></ul>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header bg-white"><strong>Coeficientes</strong></div>
          <ul class="list-group list-group-flush" id="lista-coef"></ul>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header bg-white"><strong>Formulação</strong></div>
          <div class="card-body">
            <p><code id="fo"></code></p>
            <ul id="lista-restricoes" class="ps-3"></ul>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col">
        <div class="card shadow-sm">
          <div class="card-header bg-white"><strong>Passo a Passo</strong></div>
          <ol class="list-group list-group-numbered list-group-flush" id="lista-passo"></ol>
        </div>
      </div>
    </div>

    <div class="row mb-5">
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-header bg-white"><strong>Resultado Ótimo / Exploração</strong></div>
          <div class="card-body">
            <div id="resultado-detalhado"></div>
            <pre id="json-resultado" class="small"></pre>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-header bg-white"><strong>Gráfico de x*</strong></div>
          <div class="p-3">
            <canvas id="chart-x"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-5">
      <div class="col">
        <div class="card shadow-sm">
          <div class="card-header bg-white"><strong>Exploração Manual</strong></div>
          <div class="card-body">
            <form id="form-x" class="row gy-2"></form>
            <button id="btn-atualiza" class="btn btn-outline-primary mt-2">
              Atualizar Valores
            </button>
          </div>
        </div>
      </div>
    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
  </script>
  <script>
    const links = document.querySelectorAll('.nav-link');
    let chart, coefObj, restricoesDet;

    links.forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        links.forEach(x => x.classList.remove('active'));
        a.classList.add('active');
        fetchAndRender(a.dataset.endpoint);
      });
    });

    async function fetchAndRender(url) {
      const res = await fetch(url);
      const d   = await res.json();

      document.getElementById('titulo').textContent       = d.questao;
      document.getElementById('descricao').textContent   = d.funcao_objetivo;
      document.getElementById('historia-text').textContent = d.historia || "";

      const ulv = document.getElementById('lista-vars');
      ulv.innerHTML = "";
      for (let [k,v] of Object.entries(d.variaveis_decisao)) {
        ulv.innerHTML += `<li class="list-group-item">${k} → ${v}</li>`;
      }

      const ulc = document.getElementById('lista-coef');
      ulc.innerHTML = "";
      for (let [k,c] of Object.entries(d.dados.coef_obj)) {
        ulc.innerHTML += `<li class="list-group-item">c<sub>${k}</sub> = ${c}</li>`;
      }

      document.getElementById('fo').textContent = d.funcao_objetivo;
      const ulr = document.getElementById('lista-restricoes');
      ulr.innerHTML = "";
      d.restricoes.forEach(r => {
        ulr.innerHTML += `<li>${r}</li>`;
      });

      const ulp = document.getElementById('lista-passo');
      ulp.innerHTML = "";
      d.passo_a_passo.forEach(p => {
        ulp.innerHTML += `<li class="list-group-item">${p}</li>`;
      });

      renderResultado(d.resultado.x, d.resultado.Z, []);

      document.getElementById('json-resultado').textContent =
        JSON.stringify(d.resultado, null, 2);
        
      const ctx = document.getElementById('chart-x');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(d.variaveis_decisao),
          datasets: [{ label: 'x*', data: Object.values(d.resultado.x) }]
        },
        options: { responsive: true }
      });

      coefObj       = d.dados.coef_obj;
      restricoesDet = d.restricoes_detalhadas;

      const formX = document.getElementById('form-x');
      formX.innerHTML = '';
      Object.keys(d.variaveis_decisao).forEach(v => {
        formX.innerHTML += `
          <div class="col-md-3">
            <label for="in-${v}" class="form-label">${v}</label>
            <input type="number" id="in-${v}" class="form-control"
                   value="${d.resultado.x[v]}" min="0" step="1">
          </div>`;
      });

      document.getElementById('btn-atualiza').onclick = recalcula;
    }

    function renderResultado(xs, Z, status) {
      const det = ['<div class="alert alert-info">'];
      det.push('<h5>Exploração Manual / Ótimo:</h5><ul>');
      Object.entries(xs).forEach(([v,x]) => {
        det.push(`<li>${v} = ${x}</li>`);
      });
      det.push('</ul>');
      det.push(`<strong>Z = ${Z.toFixed(2)}</strong>`);
      if (status.length) {
        det.push('<hr><ul>');
        status.forEach(s =>
          det.push(`<li class="${s.ok? 'text-success':'text-danger'}">
                      ${s.texto}
                    </li>`));
        det.push('</ul>');
      }
      det.push('</div>');
      document.getElementById('resultado-detalhado').innerHTML = det.join('');
    }

    function recalcula() {
      const xs = {};
      Object.keys(coefObj).forEach(v => {
        xs[v] = parseFloat(document.getElementById(`in-${v}`).value) || 0;
      });

      const Z = Object.entries(xs)
        .reduce((s,[v,x]) => s + coefObj[v]*x, 0);

      const status = restricoesDet.map((r,i) => {
        const lhs = Object.entries(xs)
          .reduce((s,[v,x]) => s + (r.coef[v]||0)*x, 0);
        return {
          texto: `R${i+1}: ${lhs.toFixed(1)} ${r.sentido} ${r.rhs}`,
          ok: (r.sentido === '<=' ? lhs <= r.rhs : lhs >= r.rhs)
        };
      });

      renderResultado(xs, Z, status);
      chart.data.datasets[0].data = Object.values(xs);
      chart.update();
    }

    fetchAndRender('http://127.0.0.1:8000/api/questao1');
  </script>
</body>
</html>
